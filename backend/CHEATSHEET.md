# FastAPI + SQLite Database Implementation Cheatsheet

This document provides a quick reference for the database architecture implemented in the Clarity project.

## Core Setup

### 1. Database Configuration (`database.py`)
- **Engine**: SQLite (default) with `check_same_thread=False` for FastAPI compatibility.
- **Foreign Keys**: Enabled via SQLAlchemy event listener (`PRAGMA foreign_keys=ON`).
- **Dependency**: `get_db()` provides a scoped session for each request.

### 2. Implementation Rules
- **ORM**: SQLAlchemy.
- **Base**: `declarative_base()` used for all models.
- **Migrations**: Ready for PostgreSQL migration by changing `DATABASE_URL`.
- **Session Strategy**: Session-based tracking using `session_id` (UUID generated by frontend).

---

## Schema Overview

### Sessions Table
| Column | Type | Description |
| :--- | :--- | :--- |
| `session_id` | TEXT (PK) | Unique ID for the visit. |
| `created_at` | DATETIME | Timestamp of creation. |
| `user_agent` | TEXT | Browser/Client info. |
| `client_ip` | TEXT | IP address for debugging. |

### Tasks & Steps
- **Tasks**: Stores AI-generated task titles and original user input.
- **Task Steps**: One-to-many relationship with Tasks. `step_number` maintains order.

### Panic & Grounding
- **Panic Events**: Logs when the panic button is pressed and the AI's response.
- **Grounding Exercises**: Guided exercises linked to specific panic events.

### AI Logs (Internal)
- Tracks every AI prompt and response for debugging and refinement.
- **Note**: Never expose this table to the frontend.

---

## Code Snippets

### Using the DB in an Endpoint
```python
@app.post("/tasks")
def create_task(task_data: TaskCreate, db: Session = Depends(get_db)):
    db_task = models.Task(**task_data.dict())
    db.add(db_task)
    db.commit()
    db.refresh(db_task)
    return db_task
```

### Enabling Foreign Keys in SQLite
```python
@event.listens_for(Engine, "connect")
def set_sqlite_pragma(dbapi_connection, connection_record):
    cursor = dbapi_connection.cursor()
    cursor.execute("PRAGMA foreign_keys=ON")
    cursor.close()
```

---

## Maintenance & Scalability
- **Debug-First**: Everything is logged in `ai_logs` and `sessions`.
- **Extensible**: New tables can be added to `models.py` and linked via `session_id`.
- **Portability**: To switch to PostgreSQL, update the `DATABASE_URL` environment variable.
